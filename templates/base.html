{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Bookish Nook{% endblock %}</title>

    <!-- Fonts & Bootstrap -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    {% block extra_head %}{% endblock %}
  </head>

  <body class="bn-bg">

    {% include "includes/header.html" %}
    {% include "includes/messages.html" %}

    <main class="container my-4">
      {% block content %}{% endblock %}
    </main>

    {% include "includes/footer.html" %}

    <!-- Defer scripts to avoid render-blocking -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- Got help from chatGPT with modals -->
    {% block extra_js %}
    <script defer>
    document.addEventListener("DOMContentLoaded", function() {
      const form = document.getElementById("footerNewsletterForm");
      const msg  = document.getElementById("footerNewsletterMsg");
      if (!form) return;
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "Subscribingâ€¦";
        const res = await fetch(form.action, {
          method: "POST",
          headers: {"X-Requested-With": "XMLHttpRequest"},
          body: new FormData(form)
        });
        if (res.ok) {
          const data = await res.json();
          msg.className = "small mt-2 text-success";
          if (data.requires_confirmation) {
            msg.textContent = "Check your inbox for a confirmation link. ðŸ’Œ";
          } else if (data.already_confirmed) {
            msg.textContent = "Youâ€™re already on the list. ðŸ˜Š";
          } else {
            msg.textContent = "You're subscribed! ðŸ’Œ";
          }
          form.reset();
        } else {
          const data = await res.json().catch(()=>({error:"Please enter a valid email."}));
          msg.className = "small mt-2 text-danger";
          msg.textContent = data.error || "Please enter a valid email.";
        }
      });
    });
    </script>
    {% endblock %}

    <!-- Auth Modals -->
    <div class="modal fade" id="authModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <button type="button" class="close ml-auto mr-2 mt-1" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <div id="authModalBody" class="modal-body p-0">
            <div class="p-4 text-center text-muted">Loadingâ€¦</div>
          </div>
        </div>
      </div>
    </div>

    <script>
    (function(){
      function showModal(el){
        if (window.bootstrap && bootstrap.Modal) { new bootstrap.Modal(el).show(); return; }
        if (window.jQuery && jQuery.fn && jQuery.fn.modal) { jQuery(el).modal('show'); return; }
        el.classList.add('show'); el.style.display='block'; el.removeAttribute('aria-hidden');
      }
      async function openAuthModal(url){
        const modal = document.getElementById('authModal');
        const body  = document.getElementById('authModalBody');
        if (!modal || !body) { window.location.href = url; return; }
        body.innerHTML = '<div class="p-4 text-center text-muted">Loadingâ€¦</div>';
        showModal(modal);
        try {
          const res  = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) { window.location.href = url; return; }
          const html = await res.text();
          const doc  = new DOMParser().parseFromString(html, 'text/html');
          const frag = doc.querySelector('#auth-fragment');
          if (frag) {
            body.innerHTML = frag.innerHTML;
            body.querySelectorAll('a[href^="/accounts/"]').forEach(a => {
              a.setAttribute('data-auth-modal','1');
            });
          } else {
            window.location.href = url;
          }
        } catch (e) {
          window.location.href = url;
        }
      }
      document.addEventListener('click', function(e){
        const a = e.target.closest('a[data-auth-modal]');
        if (!a) return;
        e.preventDefault();
        openAuthModal(a.getAttribute('href'));
      });
    })();
    </script>
  </body>
</html>
