{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Bookish Nook{% endblock %}</title>

    <!-- Fonts & Bootstrap -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    {% block extra_head %}{% endblock %}
  </head>

  <body class="bn-bg">

    {% include "includes/header.html" %}
    {% include "includes/messages.html" %}

    <main class="container my-4">
      {% block content %}{% endblock %}
    </main>

    {% include "includes/footer.html" %}

    <!-- Defer scripts to avoid render-blocking -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" defer></script>

    <!-- Got help from chatGPT with scripts-->
    <!-- Newsletter -->
    {% block extra_js %}
    <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
      var form = document.getElementById("footerNewsletterForm");
      var msg  = document.getElementById("footerNewsletterMsg");
      if (!form || !msg) return;

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        msg.textContent = "Subscribing…"; // OK i validatorn
        fetch(form.action, {
          method: "POST",
          headers: {"X-Requested-With": "XMLHttpRequest"},
          body: new FormData(form)
        })
        .then(function (res) {
          if (!res.ok) return res.json().then(function (d){throw d;});
          return res.json();
        })
        .then(function (data) {
          msg.className = "small mt-2 text-success";
          if (data.requires_confirmation) {
            msg.textContent = "Check your inbox for a confirmation link.";
          } else if (data.already_confirmed) {
            msg.textContent = "You’re already on the list.";
          } else {
            msg.textContent = "You're subscribed!";
          }
          form.reset();
        })
        .catch(function () {
          msg.className = "small mt-2 text-danger";
          msg.textContent = "Please enter a valid email.";
        });
      });
    });
    </script>
    {% endblock %}

    <!-- Auth Modals -->
    <div class="modal fade" id="authModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <button type="button" class="close ml-auto mr-2 mt-1" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <div id="authModalBody" class="modal-body p-0">
            <div class="p-4 text-center text-muted">Loading…</div>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      (function () {
        function showModal(el) {
          if (window.bootstrap && bootstrap.Modal) { new bootstrap.Modal(el).show(); return; }
          if (window.jQuery && jQuery.fn && jQuery.fn.modal) { jQuery(el).modal("show"); return; }
          el.classList.add("show");
          el.style.display = "block";
          el.removeAttribute("aria-hidden");
        }

        function openAuthModal(url) {
          var modal = document.getElementById("authModal");
          var body  = document.getElementById("authModalBody");
          if (!modal || !body) { window.location.href = url; return; }

          body.innerHTML = '<div class="p-4 text-center text-muted">Loading…</div>';
          showModal(modal);

          fetch(url, { credentials: "same-origin" })
            .then(function (res) { if (!res.ok) throw new Error("nav"); return res.text(); })
            .then(function (html) {
              var doc  = new DOMParser().parseFromString(html, "text/html");
              var frag = doc.querySelector("#auth-fragment");
              if (frag) {
                body.innerHTML = frag.innerHTML;
                body.querySelectorAll('a[href^="/accounts/"]').forEach(function (a) {
                  a.setAttribute("data-auth-modal", "1");
                });
              } else {
                window.location.href = url;
              }
            })
            .catch(function () {
              window.location.href = url;
            });
        }

        document.addEventListener("click", function (e) {
          var a = e.target.closest("[data-auth-modal]");
          if (!a) return;
          e.preventDefault();
          openAuthModal(a.getAttribute("href"));
        });
      })();
    </script>
  </body>
</html>
